<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>로드뷰 테스트</title>
<style>
body { font-family: 'Malgun Gothic', sans-serif; margin: 0; padding: 20px; }
#map { width: 100%; height: 400px; border: 1px solid #ccc; }
#roadview { width: 100%; height: 400px; border: 1px solid #ccc; margin-top: 10px; display: none; background: #f0f0f0; }
#roadview.active { display: block; }
.btn { padding: 10px 20px; margin: 10px 5px 10px 0; cursor: pointer; }
.btn.active { background: #1976D2; color: white; }
#status { margin: 10px 0; padding: 10px; background: #e3f2fd; border-radius: 4px; }
</style>
</head>
<body>
<h2>카카오맵 로드뷰 테스트</h2>

<div>
<button class="btn" onclick="enableRoadviewMode()">로드뷰 모드 켜기</button>
<button class="btn" onclick="closeRoadview()">로드뷰 닫기</button>
</div>

<div id="status">상태: 대기중</div>
<div id="map"></div>
<div id="roadview"></div>

<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=7e60f6a42602329b925c66ea6db3bd87&libraries=services&autoload=false"></script>
<script>
var map;
var roadview = null;
var roadviewClient = null;
var clickListener = null;

function log(msg) {
    document.getElementById('status').textContent = '상태: ' + msg;
    console.log(msg);
}

kakao.maps.load(function() {
    log('카카오맵 로드 완료');

    var container = document.getElementById('map');
    map = new kakao.maps.Map(container, {
        center: new kakao.maps.LatLng(37.5665, 126.9780),
        level: 5
    });

    // roadviewClient 초기화
    roadviewClient = new kakao.maps.RoadviewClient();
    log('지도 및 로드뷰 클라이언트 초기화 완료 - "로드뷰 모드 켜기" 버튼을 누르세요');
});

function enableRoadviewMode() {
    log('로드뷰 모드 활성화 - 지도를 클릭하세요');

    if (clickListener) {
        kakao.maps.event.removeListener(clickListener);
    }

    clickListener = kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        var latlng = mouseEvent.latLng;
        log('클릭 위치: ' + latlng.getLat().toFixed(6) + ', ' + latlng.getLng().toFixed(6));
        showRoadview(latlng.getLat(), latlng.getLng());
    });
}

function showRoadview(lat, lng) {
    var position = new kakao.maps.LatLng(lat, lng);
    log('로드뷰 검색중...');

    roadviewClient.getNearestPanoId(position, 50, function(panoId) {
        log('getNearestPanoId 결과: ' + panoId);

        if (panoId === null) {
            log('이 위치에는 로드뷰가 없습니다 (50m 이내)');
            return;
        }

        // 로드뷰 컨테이너 먼저 표시
        var rvContainer = document.getElementById('roadview');
        rvContainer.classList.add('active');
        log('로드뷰 컨테이너 표시됨');

        // 로드뷰 초기화 (한 번만)
        if (!roadview) {
            roadview = new kakao.maps.Roadview(rvContainer);
            log('로드뷰 객체 생성됨');
        }

        // 로드뷰 표시
        roadview.setPanoId(panoId, position);
        log('로드뷰 표시 완료! panoId=' + panoId);
    });
}

function closeRoadview() {
    document.getElementById('roadview').classList.remove('active');
    log('로드뷰 닫힘');
}
</script>
</body>
</html>
